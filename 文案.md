# 引入

> 每多一个晚上愿意多抬头仰望星空一会儿的年轻人，这个民族就离真正的星辰大海更近一步。
>
> <p align="right">——鬼蝉</p>

照片测星定位，是一种根据照片上的星星、时间、铅垂线等信息，计算出拍摄位置的技术

如果你还不是很了解它，推荐先看下这些视频

我们也把它做成了软件，推荐也去看看哦

本期视频将为大家讲解照片测星定位的详细数学原理，初中生也能看懂！

看完后，你也可以自己定位！

# 0. 前置知识

该部分将速通一下用到的初中以外的知识，已经学过的可以跳过

## 0.1 三角函数

### 0.1.1 弧度制与任意角

我们已经知道了如何用角度来表示一个角的大小

但是为了更加方便与简洁，我们需要引入弧度制

对于一个扇形的圆心角 $\alpha$，其弧度数为弧长 $l$ 与半径 $r$ 的比值

即 $\alpha = \frac{l}{r}$

图中这个角就是 1 弧度

弧度的单位为 $\mathrm{rad}$，通常省略不写

我们规定，把始边逆时针旋转得到终边，形成的夹角是正的

顺时针旋转，形成的夹角是负的，没错，角度也可以是负数

### 0.1.2 三角函数，不仅是锐角！

我们已经学会了锐角三角函数的使用

但实际上，三角函数的支持范围远不止于此

这里，我们来看一下实数范围内的三角函数

以 $x$ 轴正半轴为始边，旋转 $\theta$ 得到终边

在终边上取一点 $P(x, y)$，$P$ 到原点的距离为 $r$

则有 $\begin{matrix} \sin\theta = \frac{y}{r} & \cos\theta = \frac{x}{r} & \tan\theta = \frac{y}{x} \end{matrix}$

这就意味着有时三角函数值也可以是负的

再回头看这组定义式，你还能发现什么？

由勾股定理，不难发现，对于同一个角 $\alpha$，有

### 0.1.3 反三角函数

反三角函数，就是三角函数的反函数（好像是废话）

它的意思就是已知三角函数值，求这个角

“反”可以用前缀 arc- 表示

但是，在一圈内，一个 $\tan x$ 对应两个 $x$，无法满足我们的需求

于是，就有了 $\mathrm{atan2}(y, x)$

该函数有两个自变量，代表一个点的坐标

函数值为该点的方位角，即图中的 $\theta$，范围在 $(-\pi, \pi]$

## 0.2 向量

### 0.2.1 向量的概念与表示

向量是既有大小又有方向的量，可以用一个带箭头的线段表示

向量可记作小写字母，印刷使用粗体 $\boldsymbol a$，手写在在上面加个小箭头 $\vec a$

或是起点在前，终点在后，记作 $\vec{AB}$

向量的大小，即长度，称为向量的模，记作 $|\boldsymbol a|$

向量也可以表示为各个方向的分量，记法类似于坐标

向量也可以是三维甚至一维的

### 0.2.2 向量的线性运算

向量的加法遵循平行四边形法则

或三角形法则

也可以将各分量分别相加，得到向量和

一个向量 $\boldsymbol a$ 和一个实数 $\lambda$ 相乘时

其模长满足这个关系

当 $\lambda > 0$ 时，$\lambda\boldsymbol a$ 与 $\boldsymbol a$ 方向相同

当 $\lambda < 0$ 时，$\lambda\boldsymbol a$ 与 $\boldsymbol a$ 方向相反

也可以将各分量分别与 $\lambda$ 相乘

基于此，记 $\boldsymbol i = (1, 0), \boldsymbol j = (0, 1)$

则任意一向量都可改写成这样的形式

实际上，在刚才用坐标表示向量时，已经用到了这种思想

### 0.2.3 向量的点乘与夹角

对于两个互成 $\theta$ 角的向量 $\boldsymbol a, \boldsymbol b$，我们规定向量的点乘

$\boldsymbol a \cdot \boldsymbol b = |\boldsymbol a| |\boldsymbol b| \cos\theta$

我们给它变形一下

这时候就有人要问了

up up，我想要的就是向量夹角，但你点乘就要用到夹角啊？

好问题，那么，向量点乘还可以怎么算呢？

还记得我们之前的 $\boldsymbol i = \left(1, 0\right), \boldsymbol j = \left(0, 1\right)$ 吗？

由点乘的定义，不难得到

$\boldsymbol i^2 = \boldsymbol j^2 = 1, \boldsymbol i \cdot \boldsymbol j = 0$

我们来算一下这两个向量的点乘

这样，我们就可以直接计算向量点乘，进而计算向量夹角！

该算法在三维同样适用

## 0.3 空间解析几何

### 0.3.1 空间直角坐标系

我们已经知道了如何使用平面直角坐标系

但很可惜我们终究不是二次元，因此需要引入空间直角坐标系

需要注意的是，与 Minecraft 中不同，$x, y, z$ 轴是像图中这样排列的

这样，我们就可以表示三维空间中的点坐标和向量

### 0.3.2 球

考虑一个球心在原点的球

球面上每个点到球心的距离都是相等的，均为半径 $r$

由此，我们就可以写出这个球的方程

### 0.3.3 平面的点法式方程

不难想象出，确定空间中平面上一个和平面垂直的向量和平面上一点就可以确定唯一的一个平面

我们称这个向量为平面的法向量

已知法向量 $\boldsymbol n = (a, b, c)$，平面上一点 $P(x_0, y_0, z_0)$

如何求出这个平面的方程呢？

求平面的方程，就是求平面上任意一点都满足的方程

在平面上任取一点 $Q(x, y, z)$，则有

由于 $\boldsymbol n$ 与平面垂直，所以一定有 $\vec{PQ} \perp \boldsymbol n$

还记得之前的向量点乘吗？

由定义得，两垂直的向量点积为 0；而同时点积又等于各分量相乘之和

那么就可以写出这个方程

没错，这就是该平面的方程！好诶~

# 1. 从“过洋牵星术”到双星定位法

## 1.1 过洋牵星术

早在古代，就有了一种叫“过洋牵星术”的技术

人们通过测量北极星的高度，就可以在茫茫大海上确定自己的纬度

这是怎么做到的呢？

为方便研究，我们可以假想星星都投影在一个以地球为中心的半径无穷大的天球上

恒星在天球上的位置几乎固定不变，因而得名“恒星”

其中，北极星就几乎处于北天极的位置

也就是说，它的直射点在地球的北极

星星的直射点，我们称为星星的地理位置，英文简称 GP

现在有一艘船，上面的人已经测出了北极星的高度角 $\phi$，如何知道它所在的纬度呢？

让我们画上辅助线

没错，纬度就是高度角 $\phi$！

## 1.2 双星定位法

尝试一下，这个结论可以推广到任何星星吗？

这里，我们再引入天顶的概念

抬头看向你的正上方，那个方向就是天顶

星星与天顶的夹角，称为星星的天顶角，这里记作 $\theta$

不难看出，天顶角就是高度角的余角

相信已经有眼尖的观众发现了，这个角就等于天顶角啊

也就是说，观测者所在地和星星的 GP 分别与地心连线，形成的夹角就等于观测者看这颗星星的天顶角！

反过来，已知一颗星星的 GP 和天顶角，那么观测者一定在一个确定的圆上

如果你知道两颗星星，那么就会得到两个交点

这时候用一下空间想象力，根据照片上两颗星星的位置关系，就可以得到正确的那个交点

恭喜你已经掌握了双星定位法！

想象力不足的朋友们（其实也包括我）也不用担心，因为从第 3 颗星星开始，就只有一个公共点了

那么下面的思路就很明确了

我们要求出照片上每颗星星的 GP 和天顶角

然后的事情就如瓮中捉鳖了

# 2. 星星 GP 的确定

## 2.1 经纬度的表示

在这一切开始之前，我们先看看怎么统一便捷地处理经纬度

纬度分南北，经度分东西，一直带个小尾巴处理那就太麻烦了

为此，我们规定：北纬为正，南纬为负；东经为正，西经为负

当然，把西经转到 180°~360° 也是一样的

## 2.2 时角、赤纬与 GP

打开星图软件（如 Stellarium），调好时间，把位置调到 (0°, 0°)，我们可以查询到星星的时角和赤纬

赤纬是纬度在天球上的投影，就等于 GP 的纬度

时角就等于从你所在的经线向西转到星星 GP 所在的经线，转过的角度

单位用 24 h 划分了一圈，换成角度就是 1 h 15°

由于刚才已经站到了 0° 经线上，我们便能得到 GP 经度的计算公式

这样，我们就可以得到每颗星星的 GP 啦

# 3. 照片成像原理与像素焦距

## 3.1 理论夹角

在上一节中，我们求出了每颗星星的 GP

借此，我们就可以计算出星光之间的夹角

由于星星十分遥远，这个夹角在地球上任何地方看都是一样的

要计算这个夹角，首先，我们要把星星的 GP 转化为向量

我们把地心放在原点，规定 $z$ 轴正方向为北，$x$ 轴正半轴穿过 (0°, 0°)

为表示与计算方便，在本视频中，地球的半径都为 1

考虑一个纬度为 $\phi$，经度为 $\lambda$ 的 GP

我们不妨就求这个从地心到 GP 的单位方向向量 $\boldsymbol n$

让我们画上各分量与辅助线，标上已知的角

看着图，我们就可以写出 $\boldsymbol n$ 的表达式

于是，要计算两个星光之间的夹角，我们只要先将 GP 转化为向量

然后用这个公式计算两向量之间的夹角即可

这个夹角，我们称之为理论夹角

## 3.2 像素焦距的计算

一般来说，一张照片可视为从一个视点看外面的世界，投影到一个平面上

视点所在的主光轴穿过照片的正中心（除非照片裁过）

视点到照片的距离，我们称为像素焦距，记为 $z$，单位为像素

怎么求出像素焦距呢？

对于一颗照片上位于 $(x, y)$ 的星星来说，其星光的方向向量为 $(x, y, z)$

选取两颗星星 $(x_1, y_1)$ 和 $(x_2, y_2)$，它们星光 $\boldsymbol a, \boldsymbol b$ 之间的夹角应该就是刚才计算出来的理论夹角
$\theta$

由此，我们可以列出方程

这个方程乍看上去很吓人啊，以至于我去年都没解出来，润去用二分法了

但其实，只要换个元，令 $z^2 = t$

两边平方一下

看出来了吗？这实际上就是一个一元二次方程

让我们把它再整理一下

这式子漂不漂亮？这式子太漂亮了！

代入求根公式，就可以解得 $t$

这里，有时 $t$ 的两根为一正一负，取正的即可

但在某些情况下，你会得到两个 $t$ 的正根

为什么会这样呢？这时候又该取哪个 $t$ 呢？

这就要回到图上来解释了

现在我们不知道 $z$ 是多少

尝试取一个 $z$，这时候将视点与星星连线，形成的夹角称为尝试夹角

对于两个不同象限内的星星，尝试夹角随着 $z$ 的增大而减小（在高中，我们说尝试夹角关于 $z$ 单调递减）

而对于两个相同象限内的星星，尝试夹角随着 $z$ 的增大先增大后减小

这就会导致在增区间也存在一个 $z$，使该位置的尝试夹角等于理论夹角

很显然，我们要的是较大的那个

所以如果你得到了两个 $t$ 的正根，取较大的那个

最后，细节决定成败

不要忘了将 $t$ 开方得到的才是 $z$！

# 4. 天顶位置确定与天顶角

## 4.1 天顶位置确定

根据透视原理，一张照片上的平行线必将交汇于一点

我们让这张照片上的铅垂线都交汇于一点，这个点就是天顶

但是，直线这么多，误差又不可避免，怎么确定到底取哪里呢？

诶，我们可以用这个矩阵伪逆算法

这时候就有观众要问了

主播主播，你的矩阵伪逆确实很强（并不是我的，这里为套公式需要）

但还是太吃操作了（指需要线代知识）

有没有更加简单又强势的算法推荐一下吗

有的兄弟，有的

这么强的算法当然是不止一个了，一共有 6 位

这里给大家推荐初中生也能轻松掌握，且精度不错的中位数 2 算法

首先，画出所有的直线，两两计算它们的交点

然后，对于横坐标和纵坐标，我们分别计算它们的平均值和标准差（标准差就是方差的算术平方根）

排除掉所有横坐标或纵坐标与平均值相差大于两倍标准差的离谱的数据

对于留下来的数据，分别取它们的中位数

这样就能得到一个较精确坐标，我们把它作为天顶的坐标

## 4.2 天顶角

现在，我们已经知道了照片上各星星的位置、天顶位置与像素焦距

还是用老方法，就可以算出每颗星星的天顶角

回顾一下，我们已经得到了每颗星星的 GP 和天顶角

那么现在，就万事俱备，只欠东风了

# 5. 定位计算

## 5.1 平面方程

在“双星定位法”那一节中，我们发现已知一颗星星的 GP 和天顶角，观测者就一定在一个确定的圆上

圆上的点和 GP 分别与地心连线，形成的夹角就是天顶角

那么，如何表示出这个圆呢？

这个圆可以视作空间中一个平面去截这个球，得到的公共部分

那么我们只要求出这个平面，再与球联立，就可以表示出这个圆

记星星的单位方向向量为 $\boldsymbol n$，天顶角为 $\theta$

不难看出，$\boldsymbol n$ 就是平面的法向量

而平面经过 $\boldsymbol n \cos\theta$ 的末端

由此，若 $\boldsymbol n = (a, b, c)$，则可列出平面的方程

还记得 $\boldsymbol n$ 是怎么用 GP 经纬度表示的吗？

这，就是一颗星星的平面方程

## 5.2 双星定位与最终结果

现在来到最后一步！

我们已经有了每颗星星的平面方程

对于一次双星定位，我们只要把两颗星星的平面方程和地球的方程联立

不出意外的话会得到两组解（出意外的话就把这次舍掉）

是两个空间直角坐标

我们把空间直角坐标转化为经纬度

对星星两两进行定位，会得到很多个坐标

挑出每次双星定位两个坐标中正确的那个

对它们的纬度和经度取中位数，就能得到最终的结果

恭喜你完成了一次照片测星定位！
